---
layout: post
title: iOS.Core.Animation笔记
---

![image](/AllenChiangBlog/public/upload/2014-05-04-cover_of_iOS.Core.Animation.png)

Core Animation并不只是包含动画，其实动画只是他的一部分，更合适的名称应该是Layer Kit。

## 1.The Layer Tree

凡是开发过iOS或者Mac OS应用的同学都应该知道view的概念。view是一个矩形的用于显示内容（比如图像，文字，视频等）的对象。
在iOS中，所有的view都继承自UIView。UIView可以控制用户事件并且支持Core Graphic绘图，仿射变换（例如旋转和拉伸），以及简单的动画比如滑动和渐隐。
同时你可能已经发现了UIView并不是他自己处理了这一切，其实绘图，布局和动画都是由CALayer来控制的。

### CALayer

CALayer和UIView非常类似，最主要去区别就是CALayer不处理用户交互行为，也就是说CALayer并不能感知[responder chain](https://developer.apple.com/library/iOs/documentation/EventHandling/Conceptual/EventHandlingiPhoneOS/event_delivery_responder_chain/event_delivery_responder_chain.html)的存在所以他不能响应用户交互的事件，但他也用于对交互行为触发位置的落点判断。

我们为什么要了解CALayer的存在，因为他有一些UIView不能做的事情：

1. 阴影、圆角、多彩的border

2. 3D变化和定位

3. 非矩形的边界

4. alpha遮罩

5. 多步非线性动画

## 2. The Backing Image

### contents

CALayer的contents属性的类型是id，主要是为了同时支持Mac OS和iOS，在Mac OS下contents可以被设置为NSImage，在iOS下则需要设置为CGImageRef。当然如果你设置其他类型的值，则CALayer会显示为空白。

### contentsGravity

当图片大小不是适合当前view的时候，你可能会使用view.contentMode来设置缩放和位置，其实他是通过控制CALayer的contentGravity属性来实现的

	kCAGravityCenter 			kCAGravityTop
	kCAGravityBottom 			kCAGravityLeft
	kCAGravityRight 			kCAGravityTopLeft
	kCAGravityTopRight 			kCAGravityBottomLeft
	kCAGravityBottomRight 		kCAGravityResize 
	kCAGravityResizeAspect 		kCAGravityResizeAspectFill

例如我们可以使用类似于UIViewContentModeScaleAspectFit的kCAGravityResizeAspect来设置我们的图片拉伸以适应我们layer的bounds
	self.layerView.layer.contentsGravity = kCAGravityResizeAspect;
### contentScale
contentScale用来定义像素尺寸到layer尺寸的拉伸比率，默认值是1。如果你设置了上面的contentsGravity属性，则contentScale很可能是没有效果的。
其实contentScale多用于设置高分辨率屏幕下的图片尺寸，如果=1则表示每个点代表一个像素，如果=2则表示每个点代表两个像素。因为layer的contents支持的CGImage并不知道当前分辨率的情况（UIImage支持），所以需要配合contentScale属性来支持合适的图片尺寸。以下两种方式设置contentScale都可以。
	//1.set the contentsScale to match image	self.layerView.layer.contentsScale = image.scale;

	//2.set the screen scale 	self.layerView.layer.contentsScale = [UIScreen mainScreen].scale;
### contentsRect
允许我们定义content image的一部分矩形区域用于当前layer的显示，默认值是{0,0,1,1}表示显示全部。
不同于bounds、frame通过point来度量大小，contentsRect使用的是单位坐标。在iOS中常见3各种坐标度量：

* Points -- 在非高清屏幕设备中，1point=1像素；高清屏幕设备中，1point=2像素。iOS用这种坐标来统一高清和非高清的设备坐标尺寸。

* Pixels -- CGImage使用Pixels坐标，所以要主要CGImage不适应高清屏幕显示。


* Unit -- 这种坐标更方便的用于指定相对大小，多用于OpenGL和Core Animation。


举例如{0,0,0.5,0.5}表示只显示contents的左上角四分之一,{0.5,0,0.5,0.5}表示只显示contents的右上角的四分之一，其他同理可得。

### contentsCenter

