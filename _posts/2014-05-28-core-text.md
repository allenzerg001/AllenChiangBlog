---
layout: post
title: Text Kit & Core Text 文字排版
---

# 文字排版
通常我们使用UILabel、UITextField、UITextView在iOS上展示一些我们需要的文字。前者用于简单的展示，后两者可以用于接受用户的输入。但是他们都又一个共同的缺点，就是只能展示简单的纯文本。如果我们需要展示图文混排或者稍微带一点排版样式的文字时，他们就不能满足我们的需要了，这个时候我们需要使用更底层的一些技术，比如Text Kit 或者 Core Text。

![](AllenChiangBlog/public/upload/2014-05-28-text_kit_arch_2x.png)

上图展示的iOS7的框架层次结构，可以看到基于Core Text的Text Kit为上述3个常用控件提供了技术支持。

## Text kit

Text Kit是UIKit framework中定义的一组用于提供高性能的排版、布局和展示文字的类和协议，比如展示特别的字间距、行间距、断行规则。
Text Kit中最主要的类之间的数据流图：

![](AllenChiangBlog/public/upload/2014-05-28-textkitarchitecture.png)

* Text views是指实例化以后的UITextView

* Text containers是指实例化的NSTextContainer。定义了字符串需要显示的区域，通常是一个矩形。通过继承后自定义他也可以是其他的任意形状。另外通过NSTextContainer.exclusionPath定义的UIBezierPath数组，可以定义在当前区域内不能用于text展示的例外区域。

* Layout manager是指实例化的NSLayoutManager。映射了字符到字形的对应变换关系。

* Text storage是指实例化的NSTextStorage。NSTextStorage是NSMutableAttributeString的子类，他保存了我们需要展示的字符串，以及字符串的各种样式

更形象化的展示，如下图所示

![](AllenChiangBlog/public/upload/2014-05-28-text-kit-layout.png)

如果text在一个text container中展示不完全，那么他就会展示到另外一个text container中（如果有的话）。

## Core Text
Core Text framework 是一种用于排版和展示文字的技术，他被设计得高效且易用，速度比已有的[ATSUI](http://en.wikipedia.org/wiki/ATSUI)要快2倍以上。自从Core Text随着OSX 10.5(Leopard)的推出以来，很快就取代了ATSUI的地位。


## 字符和字形(Character & Glyphs)

### 字符(Character)
字符从本质上讲是一个在特别字符集中定义的数字，比如我们在OS X中广泛使用的Unicode。Unicode标准为每一种我们可能会用到的字符，提供了唯一的数字标识。

### 字形(Glyphs)
字形是用于展示上述字符的一个图形形状。但是每个字符对应的字形，根据字体的不同、字体粗细/斜体定义的不一，并不是唯一的。
例如下图展示的字符“A”的多种字形
![字形A](AllenChiangBlog/public/upload/2014-5-28-glyph_a.gif)

另外字体对应字形也不总是一对一的，在英文中经常就有连写的写法，如下图展示f+f和f+l连写情况下的字形
![ff和fl连写](AllenChiangBlog/public/upload/2014-05-28-romanligatures.gif)

## 属性字符串(NSAttributedString)
属性字符串（NSAttributedString）在Core Text中使用广泛，接下来你可能会经常遇到他。他用于管理字符串和相关的属性集（例如：字体、字间距），这些属性可以被用于单个字符也可以是一段连续的字符串。

以下是常见的4种类型，mutable和toll free bridge

	NSAttributedString
	NSMutableAttributedString
	// Toll Free Bridge
	CFAttributedString
	CFMutableAttributedString

### 创建方法

	initWithString:
	initWithString:attributes:
	initWithAttributedString:

同时还支持从RTF或者RTFD格式的rich text直接创建

	initWithRTF:documentAttributes:
	initWithRTFD:documentAttributes:

另外还支持从HTML数据直接创建

	initWithHTML:documentAttributes:
	initWithHTML:baseURL:documentAttributes:

### 读写属性

详细参考[NSAttributedString](https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSAttributedString_Class/Reference/Reference.html#//apple_ref/occ/cl/NSAttributedString) 和 [NSMutableAttributedString](https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSMutableAttributedString_Class/Reference/Reference.html#//apple_ref/occ/cl/NSMutableAttributedString) 的reference

### 简单的绘制方法

* OSX
可以通过drawAtPoint:和drawInRect:以及drawWithRect:options:方法绘制在NSView。但是这几个方法不推荐大范围使用，特别是针对频繁的绘制text，更推荐使用Text布局引擎（这个后面会提到）

* iOS
由于没有NSView的支持，Apple特别提供了CATextLayer来帮助我们绘制。
CATextLayer有一个-(id)String 的属性，可以被设置为NSString或者NSAttrib
utedString两种类型。这样我们就可以把CATextLayer加在任何我们想要的view中，用于展示需要的text。
代码例子如下：

	NSAttributedString *attributedString ; // 假设这里已经初始化好了
	CATextLayer *textLayer = [[CATextLayer alloc ] init];
	textLayer = @“hello world”;
	// or NSAttributedString
	textLayer = attributedString;
	[self.view.layer addSublayer:textLayer];


## Text布局引擎和Font api
Core Text主要由两个部分组成，text布局引擎和font API。这里我们先介绍一下Core Text的一些基本概念，用于理解上述的两个主要部分。

- text布局引擎
text布局引擎将字符生成字形，同时将字形转换成包含多行的frames，lines以及run。而且他还提供了字形和布局相关的数据，例如字形的定位和lines和frames的尺寸。

- font API
通过NSFont和NSFontDescriptor将iOS开发者喜闻乐见的方法带给了Mac OSX的开发者们。他提供了字体的引用、字体的描述以及访问font数据结构的快捷方法。


## 参考文献
- [Core Text](https://developer.apple.com/library/mac/documentation/TextFonts/Conceptual/CocoaTextArchitecture/TypoFeatures/TextSystemFeatures.html#//apple_ref/doc/uid/TP40009459-CH6-BBCFAEGE)

- [ATSUI](http://en.wikipedia.org/wiki/ATSUI)

- [AttributedString](https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/AttributedStrings/AttributedStrings.html#//apple_ref/doc/uid/10000036-BBCCGDBG)

- [RTF](http://en.wikipedia.org/wiki/RTF)